FROM apache/spark:3.5.6-scala2.12-java11-python3-ubuntu

USER root

RUN pip install --no-cache-dir \
    fastapi==0.116.1 \
    uvicorn[standard]==0.33.0 \
    pydantic==2.10.6 \
    requests==2.32.4 \
    pyspark==3.5.6 \
    pandas==2.0.3 \
    pyarrow==17.0.0 \
    grpcio==1.70.0 \
    protobuf==5.29.5 \
    grpcio-status==1.70.0 \
    minio==7.2.10

WORKDIR /opt/spark/work-dir

ARG HADOOP_AWS_VERSION=3.3.4
ARG AWS_JAVA_SDK_VERSION=1.12.262

RUN apt-get update && apt-get install -y wget && \
    mkdir -p /opt/spark/jars && \
    wget -P /opt/spark/jars https://repo1.maven.org/maven2/org/apache/hadoop/hadoop-aws/${HADOOP_AWS_VERSION}/hadoop-aws-${HADOOP_AWS_VERSION}.jar && \
    wget -P /opt/spark/jars https://repo1.maven.org/maven2/com/amazonaws/aws-java-sdk-bundle/${AWS_JAVA_SDK_VERSION}/aws-java-sdk-bundle-${AWS_JAVA_SDK_VERSION}.jar && \
    apt-get remove -y wget && \
    apt-get autoremove -y && \
    rm -rf /var/lib/apt/lists/*

USER spark

CMD ["tail", "-f", "/dev/null"]